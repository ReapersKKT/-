<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>For You</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #0a0015;
  overflow: hidden;
  font-family: 'Georgia', 'SimSun', serif;
  cursor: default;
  user-select: none;
}

canvas#bgCanvas {
  position: fixed;
  top: 0; left: 0;
  z-index: 0;
}

canvas#fwCanvas {
  position: fixed;
  top: 0; left: 0;
  z-index: 1;
  pointer-events: none;
}

canvas#heartCanvas {
  position: fixed;
  top: 0; left: 0;
  z-index: 2;
  pointer-events: none;
}

/* ========== å¼€åœºç•Œé¢ ========== */
#opening {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 100;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: radial-gradient(ellipse at center, #1a0030 0%, #0a0015 70%);
  transition: opacity 1.5s ease;
}

#opening.hidden {
  opacity: 0;
  pointer-events: none;
}

.open-title {
  color: #fff;
  font-size: 18px;
  letter-spacing: 8px;
  margin-bottom: 60px;
  opacity: 0;
  animation: fadeUp 2s ease 0.5s forwards;
}

.open-btn {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 2px solid rgba(255, 150, 180, 0.6);
  background: radial-gradient(circle, rgba(255, 100, 150, 0.3), transparent);
  color: rgba(255, 200, 220, 0.9);
  font-size: 16px;
  letter-spacing: 4px;
  cursor: pointer;
  opacity: 0;
  animation: fadeUp 2s ease 1.5s forwards, pulse 2s ease-in-out infinite 2s;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.open-btn:hover {
  border-color: rgba(255, 150, 180, 1);
  background: radial-gradient(circle, rgba(255, 100, 150, 0.5), transparent);
  transform: scale(1.1);
  box-shadow: 0 0 40px rgba(255, 100, 150, 0.4);
}

/* ========== ä¸»ç•Œé¢ ========== */
#mainScene {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 10;
  opacity: 0;
  pointer-events: none;
  transition: opacity 2s ease;
}

#mainScene.active {
  opacity: 1;
  pointer-events: auto;
}

/* æ¶ˆæ¯å®¹å™¨ */
.msg-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  z-index: 20;
  pointer-events: none;
}

.msg-text {
  color: #fff;
  font-size: 28px;
  line-height: 2;
  letter-spacing: 4px;
  text-shadow: 0 0 20px rgba(255, 100, 150, 0.6), 0 0 40px rgba(255, 100, 150, 0.3);
  opacity: 0;
  transition: opacity 1s ease;
  white-space: nowrap;
}

.msg-text.show { opacity: 1; }

.msg-sub {
  color: rgba(255, 200, 220, 0.7);
  font-size: 16px;
  letter-spacing: 6px;
  margin-top: 30px;
  opacity: 0;
  transition: opacity 1s ease;
}

.msg-sub.show { opacity: 1; }

/* å¯¼èˆªæŒ‰é’® */
.nav-dots {
  position: fixed;
  right: 30px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 50;
  display: flex;
  flex-direction: column;
  gap: 12px;
  opacity: 0;
  transition: opacity 1s ease;
}

.nav-dots.show { opacity: 1; }

.nav-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 1px solid rgba(255, 150, 180, 0.5);
  background: transparent;
  cursor: pointer;
  transition: all 0.3s ease;
}

.nav-dot.active {
  background: rgba(255, 150, 180, 0.8);
  box-shadow: 0 0 10px rgba(255, 100, 150, 0.5);
}

.nav-dot:hover {
  background: rgba(255, 150, 180, 0.5);
}

/* åº•éƒ¨æç¤º */
.hint {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  color: rgba(255, 200, 220, 0.4);
  font-size: 12px;
  letter-spacing: 4px;
  z-index: 50;
  animation: twinkle 3s ease-in-out infinite;
}

/* çˆ±å¿ƒå…‰æ ‡è·Ÿéš */
.cursor-heart {
  position: fixed;
  pointer-events: none;
  z-index: 999;
  font-size: 16px;
  opacity: 0;
  transition: none;
  color: #ff6b9d;
  text-shadow: 0 0 6px rgba(255, 107, 157, 0.6);
}

/* ä¿¡å° */
#envelope {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 60;
  opacity: 0;
  pointer-events: none;
  transition: opacity 1s ease;
}

#envelope.show {
  opacity: 1;
  pointer-events: auto;
}

.envelope-body {
  width: 360px;
  background: linear-gradient(135deg, #fff5f7, #ffe0e8);
  border-radius: 12px;
  padding: 40px 30px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 40px rgba(255, 100, 150, 0.15);
  text-align: center;
  position: relative;
  cursor: default;
}

.envelope-body::before {
  content: '';
  position: absolute;
  top: -30px;
  left: 0;
  width: 100%;
  height: 30px;
  background: linear-gradient(135deg, #ffd0d8, #ffb0c0);
  clip-path: polygon(0 100%, 50% 0, 100% 100%);
  border-radius: 12px 12px 0 0;
}

.letter-content {
  color: #8b4060;
  font-size: 15px;
  line-height: 2.2;
  letter-spacing: 2px;
}

.letter-sign {
  color: #d4687a;
  font-size: 14px;
  margin-top: 25px;
  letter-spacing: 3px;
  font-style: italic;
}

.letter-close {
  position: absolute;
  top: 10px;
  right: 15px;
  color: #cba0b0;
  font-size: 32px; /* å¢å¤§å°ºå¯¸ */
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s;
  padding: 10px; /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
  z-index: 10;
}

.letter-close:hover { color: #d4687a; }

/* ç…§ç‰‡å¢™å…¥å£ */
.photo-btn {
  position: fixed;
  bottom: 60px;
  right: 30px;
  z-index: 50;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 1px solid rgba(255, 150, 180, 0.4);
  background: rgba(255, 100, 150, 0.1);
  color: rgba(255, 200, 220, 0.7);
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s ease;
}

.photo-btn.show { opacity: 1; }
.photo-btn:hover {
  background: rgba(255, 100, 150, 0.3);
  transform: scale(1.1);
}

/* éŸ³ä¹æŒ‰é’® */
.music-btn {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 999;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 1px solid rgba(255, 150, 180, 0.4);
  background: rgba(255, 100, 150, 0.1);
  color: rgba(255, 200, 220, 0.7);
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.music-btn:hover {
  background: rgba(255, 100, 150, 0.3);
}

.music-btn.playing {
  animation: rotate 3s linear infinite;
}

/* ========== åŠ¨ç”» ========== */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 20px rgba(255, 100, 150, 0.2); }
  50% { box-shadow: 0 0 40px rgba(255, 100, 150, 0.5); }
}

@keyframes twinkle {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 0.8; }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes floatHeart {
  0% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
  100% { transform: translateY(-200px) scale(0.3) rotate(45deg); opacity: 0; }
}

/* å€’è®¡æ—¶ */
.countdown {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  color: rgba(255, 200, 220, 0.6);
  font-size: 14px;
  letter-spacing: 6px;
  z-index: 50;
  opacity: 0;
  transition: opacity 1s ease;
}

.countdown.show { opacity: 1; }

/* åœºæ™¯5: ç²’å­çˆ±å¿ƒ */
.interactive-hint {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  color: rgba(255, 200, 220, 0.5);
  font-size: 13px;
  letter-spacing: 3px;
  animation: twinkle 2s ease-in-out infinite;
}

/* ========== çº¢åŒ…æ¸¸æˆå¼¹çª— ========== */
.game-btn {
  position: fixed;
  bottom: 60px;
  right: 30px;
  z-index: 50;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  border: 1px solid rgba(255, 50, 50, 0.4);
  background: rgba(200, 0, 0, 0.2);
  color: #fff;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.3s ease;
  animation: pulse 2s infinite;
}

.game-btn.show { opacity: 1; }
.game-btn:hover {
  background: rgba(255, 0, 0, 0.4);
  transform: scale(1.1);
}

.game-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(20, 0, 0, 0.9);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
}

.game-overlay.show {
  opacity: 1;
  pointer-events: auto;
}

.game-content {
  width: 90%;
  max-width: 600px;
  background: linear-gradient(135deg, #a30000, #5c0000);
  border: 2px solid #ffd700;
  border-radius: 16px;
  padding: 40px;
  text-align: center;
  box-shadow: 0 0 50px rgba(255, 0, 0, 0.3);
  position: relative;
}

.game-content h3 {
  color: #ffd700;
  font-size: 28px;
  letter-spacing: 4px;
  margin-bottom: 30px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.red-packet-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  margin-bottom: 30px;
}

.red-packet {
  width: 80px;
  height: 100px;
  background: #ff3333;
  border-radius: 8px;
  cursor: pointer;
  position: relative;
  transition: transform 0.3s;
  border: 1px solid #ff6666;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.red-packet::before {
  content: "ğŸ§§";
  font-size: 32px;
}

.red-packet:hover {
  transform: translateY(-5px);
  background: #ff4d4d;
}

.red-packet.opened {
  background: #fff;
  border-color: #ffd700;
  cursor: default;
  transform: none;
}

.red-packet.opened::before {
  content: "";
}

.game-result {
  height: 40px;
  color: #ffd700;
  font-size: 24px;
  font-weight: bold;
  letter-spacing: 2px;
  margin-bottom: 10px;
}

.game-close {
  position: absolute;
  top: 10px;
  right: 20px;
  font-size: 36px;
  color: rgba(255, 215, 0, 0.6);
  cursor: pointer;
  transition: color 0.3s;
}

.game-close:hover {
  color: #ffd700;
}

.game-note {
  color: rgba(255, 255, 255, 0.5);
  font-size: 14px;
}
</style>
</head>
<body>

<!-- èƒŒæ™¯æ˜Ÿç©º -->
<canvas id="bgCanvas"></canvas>
<!-- çƒŸèŠ±å±‚ -->
<canvas id="fwCanvas"></canvas>
<!-- çˆ±å¿ƒç²’å­å±‚ -->
<canvas id="heartCanvas"></canvas>

<!-- å¼€åœº -->
<div id="opening">
  <div class="open-title">è‡´ æœ€ç‰¹åˆ«çš„ä½ </div>
  <div class="open-btn" onclick="startShow()">å¼€ å¯</div>
</div>

<!-- ä¸»åœºæ™¯ -->
<div id="mainScene">
  <div class="msg-container" id="msgBox">
    <div class="msg-text" id="msgText"></div>
    <div class="msg-sub" id="msgSub"></div>
  </div>
</div>

<!-- å¯¼èˆª -->
<div class="nav-dots" id="navDots"></div>

<!-- å€’è®¡æ—¶ -->
<div class="countdown" id="countdown"></div>

<!-- åº•éƒ¨æç¤º -->
<div class="hint" id="hint" style="display:none;">ç‚¹å‡»å±å¹•ä»»æ„ä½ç½® æ”¾ä¸€æœµçƒŸèŠ±</div>

<!-- éŸ³ä¹æŒ‰é’® -->
<div class="music-btn" id="musicBtn" onclick="toggleMusic()">
  â™«
</div>
<audio id="bgMusic" loop>
  <source src="music.mp3" type="audio/mpeg">
</audio>

<!-- çº¢åŒ…æ¸¸æˆå…¥å£ -->
<div class="game-btn" id="gameBtn" onclick="openGame()">
  ğŸ§§
</div>

<!-- çº¢åŒ…æ¸¸æˆå¼¹çª— -->
<div id="gameOverlay" class="game-overlay">
  <span class="game-close" onclick="closeGame()">&times;</span>
  <div class="game-content">
    <h3>æŠ½ä¸ªæ–°å¹´çº¢åŒ…å§</h3>
    <div class="red-packet-grid" id="redPacketGrid">
      <!-- åŠ¨æ€ç”Ÿæˆçº¢åŒ… -->
    </div>
    <div class="game-result" id="gameResult"></div>
    
    <!-- å…‘æ¢å‡­è¯å¡ç‰‡ -->
    <div id="voucher" class="voucher" style="display: none;">
      <div class="voucher-inner">
        <div class="voucher-title">âœ¨ ä¸“å±å…‘æ¢åˆ¸ âœ¨</div>
        <div class="voucher-amount" id="voucherAmount"></div>
        <div class="voucher-line"></div>
        <div class="voucher-desc">å‡­æ­¤æˆªå›¾æ‰¾ç”·æœ‹å‹å…‘ç°</div>
        <div class="voucher-time" id="voucherTime"></div>
      </div>
    </div>

    <p class="game-note">ï¼ˆç‚¹å‡»çº¢åŒ…æŠ½å–æƒŠå–œï¼‰</p>
  </div>
</div>

<!-- ä¿¡å° -->
<div id="envelope">
  <div class="envelope-body">
    <span class="letter-close" onclick="closeEnvelope()">&times;</span>
    <div class="letter-content" id="letterContent"></div>
    <div class="letter-sign">â€”â€” ä½ çš„å®å®</div>
  </div>
</div>

<script>
// ===================== é…ç½®åŒºåŸŸï¼ˆå¯è‡ªå®šä¹‰ï¼‰ =====================
const CONFIG = {
  // æ¯ä¸€é¡µçš„æ–‡å­—ï¼ˆä¸»æ–‡å­— + å‰¯æ–‡å­—ï¼‰
  pages: [
    { main: "ä½ å¥½å‘€", sub: "æˆ‘æœ‰äº›è¯æƒ³å¯¹ä½ è¯´" },
    { main: "ä»é‡è§ä½ çš„é‚£å¤©èµ·", sub: "æˆ‘çš„ä¸–ç•Œå¼€å§‹æœ‰äº†è‰²å½©" },
    { main: "ä½ çš„ç¬‘å®¹", sub: "æ˜¯æˆ‘è§è¿‡æœ€ç¾çš„é£æ™¯" },
    { main: "æ–°çš„ä¸€å¹´", sub: "æˆ‘æƒ³ç»§ç»­ç‰µç€ä½ çš„æ‰‹" },
    { main: "2025 â†’ 2026", sub: "æ¯ä¸€å¤© éƒ½æƒ³å’Œä½ ä¸€èµ·åº¦è¿‡" },
    { main: "æˆ‘çˆ±ä½ ", sub: "è¿‡å»æ˜¯ ç°åœ¨æ˜¯ æœªæ¥ä¹Ÿæ˜¯", isHeart: true },
    { main: "ç‚¹å‡»å±å¹•", sub: "æ‰“å¼€æˆ‘ç»™ä½ å†™çš„ä¿¡", isLetter: true },
  ],

  // ä¿¡çš„å†…å®¹ï¼ˆHTMLæ ¼å¼ï¼Œ<br>æ¢è¡Œï¼‰
  letterText: `
    è‡­å®å®ï¼š<br><br>
    æ–°å¹´å¿«ä¹ï¼<br><br>
    æ„Ÿè°¢ä½ å‡ºç°åœ¨æˆ‘çš„ç”Ÿå‘½é‡Œï¼Œ<br>
    è®©å¹³å‡¡çš„æ—¥å­éƒ½å˜å¾—é—ªé—ªå‘å…‰ã€‚<br><br>
    æ–°çš„ä¸€å¹´ï¼Œ<br>
    æˆ‘ä¼šæ›´åŠ åŠªåŠ›ï¼Œ<br>
    æˆä¸ºå€¼å¾—ä½ ä¾é çš„äººã€‚<br><br>
    æ„¿æˆ‘ä»¬çš„æ•…äº‹ï¼Œ<br>
    æ°¸è¿œå†™ä¸åˆ°ç»“å±€ã€‚<br>
  `,

  // æ–°å¹´å€’è®¡æ—¶ç›®æ ‡ï¼ˆå¯æ”¹ä¸ºä»»ä½•æ—¥æœŸï¼‰
  newYearDate: new Date('2026-02-17T00:00:00'),

  // é¢œè‰²ä¸»é¢˜
  colors: {
    heartPink: '#ff6b9d',
    heartRed: '#ff3366',
    sparkGold: '#ffd700',
    sparkWhite: '#ffffff',
  }
};

// ===================== å…¨å±€å˜é‡ =====================
let W, H;
let bgCtx, fwCtx, heartCtx;
let stars = [];
let fireworks = [];
let particles = [];
let floatingHearts = [];
let heartParticles = [];
let currentPage = -1;
let isShowStarted = false;
let mouseX = 0, mouseY = 0;
let heartShape = [];
let showHeartParticles = false;

// ===================== åˆå§‹åŒ– =====================
function init() {
  const bgCanvas = document.getElementById('bgCanvas');
  const fwCanvas = document.getElementById('fwCanvas');
  const hCanvas = document.getElementById('heartCanvas');

  bgCtx = bgCanvas.getContext('2d');
  fwCtx = fwCanvas.getContext('2d');
  heartCtx = hCanvas.getContext('2d');

  resize();
  window.addEventListener('resize', resize);

  // ç”Ÿæˆæ˜Ÿæ˜Ÿ
  for (let i = 0; i < 200; i++) {
    stars.push({
      x: Math.random() * W,
      y: Math.random() * H,
      r: Math.random() * 1.5 + 0.5,
      alpha: Math.random(),
      delta: Math.random() * 0.02 + 0.005,
    });
  }

  // ç”Ÿæˆçˆ±å¿ƒå½¢çŠ¶çš„ç‚¹
  generateHeartShape();

  // æ„å»ºå¯¼èˆª
  buildNav();

  // é¼ æ ‡ & ç‚¹å‡»
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('click', onClick);
  document.addEventListener('touchstart', onTouch);

  // å¼€å§‹æ¸²æŸ“
  animate();

  // å€’è®¡æ—¶
  updateCountdown();
  setInterval(updateCountdown, 1000);
}

function resize() {
  W = window.innerWidth;
  H = window.innerHeight;
  [document.getElementById('bgCanvas'),
   document.getElementById('fwCanvas'),
   document.getElementById('heartCanvas')].forEach(c => {
    c.width = W;
    c.height = H;
  });
  generateHeartShape();
}

// ===================== æ˜Ÿç©ºèƒŒæ™¯ =====================
function drawStars() {
  bgCtx.clearRect(0, 0, W, H);

  // æ¸å˜èƒŒæ™¯
  const grd = bgCtx.createRadialGradient(W / 2, H / 2, 0, W / 2, H / 2, Math.max(W, H) * 0.7);
  grd.addColorStop(0, '#1a0030');
  grd.addColorStop(0.5, '#0f0020');
  grd.addColorStop(1, '#050010');
  bgCtx.fillStyle = grd;
  bgCtx.fillRect(0, 0, W, H);

  // æ˜Ÿæ˜Ÿ
  stars.forEach(s => {
    s.alpha += s.delta;
    if (s.alpha > 1 || s.alpha < 0) s.delta *= -1;
    s.alpha = Math.max(0, Math.min(1, s.alpha));

    bgCtx.beginPath();
    bgCtx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    bgCtx.fillStyle = `rgba(255, 255, 255, ${s.alpha * 0.8})`;
    bgCtx.fill();
  });
}

// ===================== çƒŸèŠ±ç³»ç»Ÿ =====================
class Firework {
  constructor(x, y, targetX, targetY) {
    this.x = x;
    this.y = y;
    this.targetX = targetX;
    this.targetY = targetY;
    this.speed = 3 + Math.random() * 2;
    this.angle = Math.atan2(targetY - y, targetX - x);
    this.vx = Math.cos(this.angle) * this.speed;
    this.vy = Math.sin(this.angle) * this.speed;
    this.trail = [];
    this.alive = true;
    this.hue = Math.random() * 60 + 330; // pink-red range
  }

  update() {
    this.trail.push({ x: this.x, y: this.y });
    if (this.trail.length > 8) this.trail.shift();

    this.x += this.vx;
    this.y += this.vy;

    const dist = Math.hypot(this.targetX - this.x, this.targetY - this.y);
    if (dist < 10) {
      this.alive = false;
      this.explode();
    }
  }

  draw(ctx) {
    // å°¾è¿¹
    for (let i = 0; i < this.trail.length; i++) {
      const t = this.trail[i];
      const alpha = i / this.trail.length * 0.5;
      ctx.beginPath();
      ctx.arc(t.x, t.y, 2, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255, 200, 220, ${alpha})`;
      ctx.fill();
    }

    // å¤´éƒ¨
    ctx.beginPath();
    ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
    ctx.fillStyle = '#ffd0e0';
    ctx.fill();
  }

  explode() {
    const count = 80 + Math.floor(Math.random() * 40);
    const isHeart = Math.random() > 0.5; // 50% æ¦‚ç‡çˆ±å¿ƒå½¢çƒŸèŠ±

    if (isHeart) {
      // çˆ±å¿ƒå½¢çŠ¶çˆ†ç‚¸
      for (let i = 0; i < count; i++) {
        const t = (i / count) * Math.PI * 2;
        const hx = 16 * Math.pow(Math.sin(t), 3);
        const hy = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
        const speed = (2 + Math.random() * 2) * 0.6;
        const angle = Math.atan2(hy, hx);
        const dist = Math.hypot(hx, hy) / 16;

        particles.push(new Particle(
          this.x, this.y,
          Math.cos(angle) * dist * speed,
          Math.sin(angle) * dist * speed,
          this.hue
        ));
      }
    } else {
      // åœ†å½¢çˆ†ç‚¸
      for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 4;
        particles.push(new Particle(
          this.x, this.y,
          Math.cos(angle) * speed,
          Math.sin(angle) * speed,
          this.hue
        ));
      }
    }
  }
}

class Particle {
  constructor(x, y, vx, vy, hue) {
    this.x = x;
    this.y = y;
    this.vx = vx;
    this.vy = vy;
    this.alpha = 1;
    this.decay = 0.008 + Math.random() * 0.012;
    this.gravity = 0.02;
    this.hue = hue + Math.random() * 30 - 15;
    this.size = 2 + Math.random() * 2;
    this.alive = true;
  }

  update() {
    this.vx *= 0.98;
    this.vy *= 0.98;
    this.vy += this.gravity;
    this.x += this.vx;
    this.y += this.vy;
    this.alpha -= this.decay;
    if (this.alpha <= 0) this.alive = false;
  }

  draw(ctx) {
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size * this.alpha, 0, Math.PI * 2);
    const r = Math.floor(255 * (this.hue > 350 || this.hue < 30 ? 1 : 0.8));
    const g = Math.floor(100 + Math.random() * 50);
    const b = Math.floor(150 + Math.random() * 50);
    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${this.alpha})`;
    ctx.shadowBlur = 6;
    ctx.shadowColor = `rgba(${r}, ${g}, ${b}, ${this.alpha * 0.5})`;
    ctx.fill();
    ctx.shadowBlur = 0;
  }
}

function launchFirework(targetX, targetY) {
  const startX = W * 0.2 + Math.random() * W * 0.6;
  fireworks.push(new Firework(startX, H, targetX || startX + (Math.random() - 0.5) * 200, targetY || H * 0.2 + Math.random() * H * 0.3));
}

function drawFireworks() {
  fwCtx.globalCompositeOperation = 'destination-out';
  fwCtx.fillStyle = 'rgba(0, 0, 0, 0.15)';
  fwCtx.fillRect(0, 0, W, H);
  fwCtx.globalCompositeOperation = 'lighter';

  fireworks = fireworks.filter(f => {
    f.update();
    f.draw(fwCtx);
    return f.alive;
  });

  particles = particles.filter(p => {
    p.update();
    p.draw(fwCtx);
    return p.alive;
  });
}

// ===================== æ¼‚æµ®çˆ±å¿ƒ =====================
function spawnFloatingHeart(x, y) {
  const size = 10 + Math.random() * 15;
  floatingHearts.push({
    x: x || Math.random() * W,
    y: y || H + 20,
    size: size,
    alpha: 0.6 + Math.random() * 0.4,
    vx: (Math.random() - 0.5) * 1,
    vy: -(1 + Math.random() * 2),
    rotation: Math.random() * Math.PI * 2,
    rotSpeed: (Math.random() - 0.5) * 0.05,
    life: 1,
    decay: 0.003 + Math.random() * 0.005,
    color: Math.random() > 0.5 ? CONFIG.colors.heartPink : CONFIG.colors.heartRed,
  });
}

function drawFloatingHearts() {
  floatingHearts = floatingHearts.filter(h => {
    h.x += h.vx + Math.sin(h.y * 0.01) * 0.3;
    h.y += h.vy;
    h.rotation += h.rotSpeed;
    h.life -= h.decay;
    if (h.life <= 0) return false;

    heartCtx.save();
    heartCtx.translate(h.x, h.y);
    heartCtx.rotate(h.rotation);
    heartCtx.globalAlpha = h.life * h.alpha;

    drawHeartSymbol(heartCtx, 0, 0, h.size, h.color);

    heartCtx.restore();
    return true;
  });
}

function drawHeartSymbol(ctx, x, y, size, color) {
  ctx.beginPath();
  const topCurveHeight = size * 0.3;
  ctx.moveTo(x, y + topCurveHeight);

  // å·¦åŠ
  ctx.bezierCurveTo(
    x, y, x - size / 2, y, x - size / 2, y + topCurveHeight
  );
  ctx.bezierCurveTo(
    x - size / 2, y + (size + topCurveHeight) / 2, x, y + (size + topCurveHeight) / 1.5, x, y + size
  );

  // å³åŠ
  ctx.bezierCurveTo(
    x, y + (size + topCurveHeight) / 1.5, x + size / 2, y + (size + topCurveHeight) / 2, x + size / 2, y + topCurveHeight
  );
  ctx.bezierCurveTo(
    x + size / 2, y, x, y, x, y + topCurveHeight
  );

  ctx.fillStyle = color;
  ctx.shadowBlur = 10;
  ctx.shadowColor = color;
  ctx.fill();
  ctx.shadowBlur = 0;
}

// ===================== ç²’å­çˆ±å¿ƒï¼ˆå¤§çˆ±å¿ƒï¼‰ =====================
function generateHeartShape() {
  heartShape = [];
  const scale = Math.min(W, H) * 0.012;
  const cx = W / 2;
  const cy = H / 2 - 20;

  for (let i = 0; i < 150; i++) {
    const t = (i / 150) * Math.PI * 2;
    const x = 16 * Math.pow(Math.sin(t), 3);
    const y = -(13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));

    heartShape.push({
      tx: cx + x * scale,
      ty: cy + y * scale,
      x: cx + (Math.random() - 0.5) * W,
      y: cy + (Math.random() - 0.5) * H,
      size: 2 + Math.random() * 3,
      speed: 0.02 + Math.random() * 0.03,
      color: Math.random() > 0.3
        ? `rgba(255, ${80 + Math.floor(Math.random() * 60)}, ${120 + Math.floor(Math.random() * 60)}, 0.8)`
        : `rgba(255, ${180 + Math.floor(Math.random() * 50)}, ${200 + Math.floor(Math.random() * 50)}, 0.6)`,
    });
  }

  // å†…éƒ¨å¡«å……ç‚¹
  for (let i = 0; i < 80; i++) {
    const t1 = Math.random() * Math.PI * 2;
    const r = Math.random() * 0.85;
    const x = 16 * Math.pow(Math.sin(t1), 3) * r;
    const y = -(13 * Math.cos(t1) - 5 * Math.cos(2 * t1) - 2 * Math.cos(3 * t1) - Math.cos(4 * t1)) * r;

    heartShape.push({
      tx: cx + x * scale,
      ty: cy + y * scale,
      x: cx + (Math.random() - 0.5) * W,
      y: cy + (Math.random() - 0.5) * H,
      size: 1.5 + Math.random() * 2,
      speed: 0.015 + Math.random() * 0.025,
      color: `rgba(255, ${150 + Math.floor(Math.random() * 80)}, ${180 + Math.floor(Math.random() * 50)}, 0.5)`,
    });
  }
}

function drawHeartParticles() {
  if (!showHeartParticles) return;

  heartShape.forEach(p => {
    // å‘ç›®æ ‡ä½ç½®ç§»åŠ¨
    p.x += (p.tx - p.x) * p.speed;
    p.y += (p.ty - p.y) * p.speed;

    // é¼ æ ‡äº¤äº’ï¼šé¼ æ ‡é è¿‘æ—¶ç²’å­æ•£å¼€
    const dx = p.x - mouseX;
    const dy = p.y - mouseY;
    const dist = Math.hypot(dx, dy);
    if (dist < 80) {
      const force = (80 - dist) / 80 * 3;
      p.x += (dx / dist) * force;
      p.y += (dy / dist) * force;
    }

    // å¾®å°æµ®åŠ¨
    p.x += Math.sin(Date.now() * 0.002 + p.tx) * 0.3;
    p.y += Math.cos(Date.now() * 0.002 + p.ty) * 0.3;

    heartCtx.beginPath();
    heartCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    heartCtx.fillStyle = p.color;
    heartCtx.shadowBlur = 8;
    heartCtx.shadowColor = p.color;
    heartCtx.fill();
    heartCtx.shadowBlur = 0;
  });
}

// ===================== é¼ æ ‡è·Ÿéšçˆ±å¿ƒ =====================
const cursorHearts = [];

function spawnCursorHeart(x, y) {
  cursorHearts.push({
    x, y,
    size: 8 + Math.random() * 10,
    alpha: 1,
    vy: -(1 + Math.random() * 1.5),
    vx: (Math.random() - 0.5) * 1.5,
    rotation: Math.random() * 0.5 - 0.25,
    color: ['#ff6b9d', '#ff3366', '#ff85b3', '#ffa0c0'][Math.floor(Math.random() * 4)],
  });
}

function drawCursorHearts() {
  cursorHearts.forEach((h, i) => {
    h.x += h.vx;
    h.y += h.vy;
    h.alpha -= 0.015;

    if (h.alpha <= 0) {
      cursorHearts.splice(i, 1);
      return;
    }

    heartCtx.save();
    heartCtx.globalAlpha = h.alpha;
    heartCtx.translate(h.x, h.y);
    heartCtx.rotate(h.rotation);
    drawHeartSymbol(heartCtx, 0, 0, h.size, h.color);
    heartCtx.restore();
  });
}

// ===================== å¯¼èˆªä¸é¡µé¢ =====================
function buildNav() {
  const nav = document.getElementById('navDots');
  CONFIG.pages.forEach((_, i) => {
    const dot = document.createElement('div');
    dot.className = 'nav-dot';
    dot.onclick = (e) => { e.stopPropagation(); goToPage(i); };
    nav.appendChild(dot);
  });
}

function goToPage(index) {
  if (index < 0 || index >= CONFIG.pages.length) return;
  currentPage = index;
  const page = CONFIG.pages[index];

  // æ›´æ–°å¯¼èˆª
  document.querySelectorAll('.nav-dot').forEach((d, i) => {
    d.classList.toggle('active', i === index);
  });

  // æ›´æ–°æ–‡å­—
  const msgText = document.getElementById('msgText');
  const msgSub = document.getElementById('msgSub');
  const envelope = document.getElementById('envelope');

  msgText.classList.remove('show');
  msgSub.classList.remove('show');

  // ç²’å­çˆ±å¿ƒæ§åˆ¶
  showHeartParticles = !!page.isHeart;

  // æ‰“å­—æœºæ•ˆæœå¤„ç†
  setTimeout(() => {
    // msgText.textContent = page.main; // æ—§çš„ç›´æ¥æ˜¾ç¤º
    typeWriter(msgText, page.main, 100, () => {
      // ä¸»æ ‡é¢˜æ‰“å­—å®Œæˆå
      launchFirework();
      setTimeout(() => launchFirework(), 300);

      setTimeout(() => {
        // msgSub.textContent = page.sub; // æ—§çš„ç›´æ¥æ˜¾ç¤º
        typeWriter(msgSub, page.sub, 80);
      }, 500);
    });
    
    msgText.classList.add('show');
  }, 300);

  // ä¿¡å°é¡µç‰¹æ®Šå¤„ç†
  if (page.isLetter) {
    setTimeout(() => {
      document.getElementById('letterContent').innerHTML = CONFIG.letterText;
    }, 500);
  }
}

// æ‰“å­—æœºæ•ˆæœå‡½æ•°
function typeWriter(element, text, speed = 100, callback) {
  element.textContent = '';
  element.classList.add('show'); // ç¡®ä¿å¯è§
  let i = 0;
  
  function type() {
    if (i < text.length) {
      element.textContent += text.charAt(i);
      i++;
      setTimeout(type, speed);
    } else {
      if (callback) callback();
    }
  }
  type();
}

function nextPage() {
  if (currentPage < CONFIG.pages.length - 1) {
    goToPage(currentPage + 1);
  }
}

function prevPage() {
  if (currentPage > 0) {
    goToPage(currentPage - 1);
  }
}

// ===================== éŸ³ä¹æ§åˆ¶ =====================
let isMusicPlaying = false;
function toggleMusic() {
  const audio = document.getElementById('bgMusic');
  const btn = document.getElementById('musicBtn');
  
  if (isMusicPlaying) {
    audio.pause();
    btn.classList.remove('playing');
  } else {
    audio.play().catch(e => {
      console.log("éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³ä¹");
      alert("è¯·å…ˆä¸é¡µé¢äº¤äº’ï¼ˆç‚¹å‡»ä»»æ„å¤„ï¼‰ä»¥å…è®¸æ’­æ”¾éŸ³ä¹");
    });
    btn.classList.add('playing');
  }
  isMusicPlaying = !isMusicPlaying;
}

// ===================== çº¢åŒ…å°æ¸¸æˆ =====================
const RED_PACKET_PRIZES = ["Â¥10", "Â¥20", "Â¥30", "Â¥40", "Â¥50", "ğŸ˜˜ä¸€ä¸ªé¦™å»"];
let hasPlayedGame = false;
let hasOpenedPacket = false;

function openGame() {
  document.getElementById('gameOverlay').classList.add('show');
  if (!hasPlayedGame) {
    initRedPackets();
  }
}

function closeGame() {
  document.getElementById('gameOverlay').classList.remove('show');
}

function initRedPackets() {
  const grid = document.getElementById('redPacketGrid');
  const resultText = document.getElementById('gameResult');
  const noteText = document.querySelector('.game-note');
  
  grid.innerHTML = '';
  grid.style.display = 'grid'; // ç¡®ä¿æ˜¾ç¤ºç½‘æ ¼
  resultText.textContent = '';
  document.getElementById('voucher').style.display = 'none'; // é‡ç½®å‡­è¯éšè—
  noteText.style.display = 'block';

  const packetCount = 6; // 6ä¸ªçº¢åŒ…
  
  // éšæœºæ‰“ä¹±å¥–å“
  let prizes = [...RED_PACKET_PRIZES];
  prizes.sort(() => Math.random() - 0.5);

  for (let i = 0; i < packetCount; i++) {
    const packet = document.createElement('div');
    packet.className = 'red-packet';
    packet.onclick = function() {
      if (this.classList.contains('opened')) return;

      if (hasOpenedPacket) {
        alert("åšäººä¸èƒ½å¤ªè´ªå¿ƒï¼ˆå¾®ç¬‘ï¼‰");
        return;
      }
      
      hasOpenedPacket = true;
      this.classList.add('opened');
      this.innerHTML = `<span style="color: #d40000; font-weight: bold; font-size: 18px;">${prizes[i]}</span>`;
      
      // æ’­æ”¾çƒŸèŠ±åº†ç¥
      for(let j=0; j<5; j++) {
        setTimeout(() => launchFirework(), j*200);
      }

      // å»¶è¿Ÿå±•ç¤ºå‡­è¯
      setTimeout(() => {
        grid.style.display = 'none'; // éšè—çº¢åŒ…ç½‘æ ¼
        noteText.style.display = 'none'; // éšè—æç¤ºæ–‡å­—
        
        const voucher = document.getElementById('voucher');
        document.getElementById('voucherAmount').textContent = prizes[i];
        document.getElementById('voucherTime').textContent = "ç”Ÿæˆæ—¶é—´: " + new Date().toLocaleString();
        voucher.style.display = 'block';
        
        // å¼¹å‡ºæç¤º
        setTimeout(() => {
            alert("æ­å–œï¼è¯·æ‰¾ä½ ç”·æœ‹å‹é¢†å–çº¢åŒ…");
        }, 300);
        
      }, 1000);
    };
    grid.appendChild(packet);
  }
  hasPlayedGame = true;
}

// ===================== ä¿¡å° =====================
function openEnvelope() {
  const envelope = document.getElementById('envelope');
  envelope.classList.add('show');
}

function closeEnvelope() {
  const envelope = document.getElementById('envelope');
  envelope.classList.remove('show');
  
  // å…³é—­ä¿¡å°åï¼Œç›´æ¥æ‰“å¼€çº¢åŒ…æ¸¸æˆï¼ˆåœ¨å±å¹•ä¸­å¤®ï¼‰
  setTimeout(() => {
    openGame();
  }, 600); // ç¨å¾®å»¶è¿Ÿç­‰å¾…ä¿¡å°æ¶ˆå¤±
}

// ===================== å€’è®¡æ—¶ =====================
function updateCountdown() {
  const now = new Date();
  const diff = CONFIG.newYearDate - now;
  const el = document.getElementById('countdown');

  if (diff <= 0) {
    el.textContent = 'æ–°å¹´å¿«ä¹';
    return;
  }

  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
  const secs = Math.floor((diff % (1000 * 60)) / 1000);

  el.textContent = `è·ç¦»æ–°å¹´è¿˜æœ‰ ${days}å¤© ${hours}æ—¶ ${mins}åˆ† ${secs}ç§’`;
}

// ===================== äº‹ä»¶ =====================
function onMouseMove(e) {
  mouseX = e.clientX;
  mouseY = e.clientY;

  if (isShowStarted && Math.random() > 0.6) {
    spawnCursorHeart(mouseX, mouseY);
  }
}

function onClick(e) {
  if (!isShowStarted) return;

  const page = CONFIG.pages[currentPage];

  // ä¿¡å°é¡µç‚¹å‡»æ‰“å¼€ä¿¡å°
  if (page && page.isLetter) {
    const envelope = document.getElementById('envelope');
    if (!envelope.classList.contains('show')) {
      openEnvelope();
      return;
    }
  }

  // æ”¾çƒŸèŠ±
  launchFirework(e.clientX, e.clientY);

  // ç”Ÿæˆçˆ±å¿ƒ
  for (let i = 0; i < 3; i++) {
    spawnFloatingHeart(e.clientX + (Math.random() - 0.5) * 40, e.clientY);
  }
}

function onTouch(e) {
  const t = e.touches[0];
  mouseX = t.clientX;
  mouseY = t.clientY;
  onClick({ clientX: t.clientX, clientY: t.clientY });
}

// é”®ç›˜ç¿»é¡µ
document.addEventListener('keydown', (e) => {
  if (!isShowStarted) return;
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown' || e.key === ' ') {
    e.preventDefault();
    nextPage();
  } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
    e.preventDefault();
    prevPage();
  }
});

// æ»šè½®ç¿»é¡µ
let wheelCooldown = false;
document.addEventListener('wheel', (e) => {
  if (!isShowStarted || wheelCooldown) return;
  wheelCooldown = true;
  setTimeout(() => wheelCooldown = false, 1200);

  if (e.deltaY > 0) nextPage();
  else prevPage();
});

// ===================== å¼€å§‹è¡¨æ¼” =====================
function startShow() {
  isShowStarted = true;

  // éšè—å¼€åœº
  document.getElementById('opening').classList.add('hidden');

  // æ˜¾ç¤ºä¸»åœºæ™¯
  setTimeout(() => {
    document.getElementById('mainScene').classList.add('active');
    document.getElementById('navDots').classList.add('show');
    document.getElementById('countdown').classList.add('show');
    // document.getElementById('gameBtn').classList.add('show'); // ç§»è‡³ä¿¡å°å…³é—­åæ˜¾ç¤º
    document.getElementById('hint').style.display = '';

    // å¼€åœºçƒŸèŠ±
    for (let i = 0; i < 5; i++) {
      setTimeout(() => launchFirework(), i * 400);
    }

    // æ˜¾ç¤ºç¬¬ä¸€é¡µ
    setTimeout(() => goToPage(0), 800);
  }, 800);

  // æŒç»­ç”Ÿæˆæ¼‚æµ®çˆ±å¿ƒ
  setInterval(() => {
    if (isShowStarted) spawnFloatingHeart();
  }, 2000);
}

// ===================== ä¸»æ¸²æŸ“å¾ªç¯ =====================
function animate() {
  requestAnimationFrame(animate);

  drawStars();
  drawFireworks();

  // æ¸…é™¤çˆ±å¿ƒç”»å¸ƒ
  heartCtx.clearRect(0, 0, W, H);
  drawFloatingHearts();
  drawCursorHearts();
  drawHeartParticles();
}

// ===================== å¯åŠ¨ =====================
window.addEventListener('load', init);
</script>

</body>
</html>
